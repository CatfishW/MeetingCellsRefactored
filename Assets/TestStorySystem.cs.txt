using UnityEngine;
using StorySystem.Core;
using StorySystem.Serialization;
using StorySystem.Nodes;

public class TestStorySystem : MonoBehaviour
{
    [ContextMenu("Test JSON Serialization")]
    void TestJsonSerialization()
    {
        Debug.Log("=== Testing Story Graph JSON Serialization ===");

        // Create a test graph
        var graph = ScriptableObject.CreateInstance<StoryGraph>();
        graph.Initialize(System.Guid.NewGuid().ToString(), "TestGraph");

        // Create nodes
        var startNode = graph.CreateNode<StartNode>(new Vector2(100, 100));
        var cutsceneNode = graph.CreateNode<CutsceneNode>(new Vector2(350, 100));
        var audioNode = graph.CreateNode<AudioNode>(new Vector2(600, 100));

        Debug.Log($"Created {graph.Nodes.Count} nodes");
        Debug.Log($"StartNode outputs: {startNode.OutputPorts.Count}, port ID: {startNode.OutputPorts[0]?.PortId}");
        Debug.Log($"CutsceneNode inputs: {cutsceneNode.InputPorts.Count}, port ID: {cutsceneNode.InputPorts[0]?.PortId}");
        Debug.Log($"CutsceneNode outputs: {cutsceneNode.OutputPorts.Count}");
        foreach (var port in cutsceneNode.OutputPorts)
        {
            Debug.Log($"  Cutscene output: {port.PortName} (ID: {port.PortId})");
        }

        // Create connections using the actual port IDs
        var conn1 = graph.CreateConnection(
            startNode.NodeId, "output",
            cutsceneNode.NodeId, "input"
        );
        if (conn1 != null)
            Debug.Log($"Created connection 1: Start.output -> Cutscene.input");
        else
            Debug.LogError("Failed to create connection 1");

        var conn2 = graph.CreateConnection(
            cutsceneNode.NodeId, "complete",
            audioNode.NodeId, "input"
        );
        if (conn2 != null)
            Debug.Log($"Created connection 2: Cutscene.complete -> Audio.input");
        else
            Debug.LogError("Failed to create connection 2");

        Debug.Log($"Total connections: {graph.Connections.Count()}");

        // Serialize to JSON
        string json = StorySerializer.ToJson(graph, true);
        Debug.Log("=== Serialized JSON ===");
        Debug.Log(json);

        // Save to file
        string path = Application.dataPath + "/TestOutput.json";
        System.IO.File.WriteAllText(path, json);
        Debug.Log($"Saved JSON to: {path}");

        // Now test deserialization
        Debug.Log("=== Testing Deserialization ===");
        var loadedGraph = StorySerializer.FromJson(json);

        if (loadedGraph != null)
        {
            Debug.Log($"Loaded graph: {loadedGraph.GraphName}");
            Debug.Log($"Nodes: {loadedGraph.Nodes.Count}");
            Debug.Log($"Connections: {loadedGraph.Connections.Count()}");

            foreach (var conn in loadedGraph.Connections)
            {
                var outputNode = loadedGraph.GetNode(conn.OutputNodeId);
                var inputNode = loadedGraph.GetNode(conn.InputNodeId);
                Debug.Log($"Connection: {outputNode?.DisplayName}.{conn.OutputPortId} -> {inputNode?.DisplayName}.{conn.InputPortId}");
            }
        }
        else
        {
            Debug.LogError("Failed to load graph from JSON!");
        }

        // Test loading from file
        Debug.Log("=== Testing Load From File ===");
        var fileGraph = StorySerializer.LoadFromFile(path);
        if (fileGraph != null)
        {
            Debug.Log($"Successfully loaded from file: {fileGraph.GraphName} with {fileGraph.Nodes.Count} nodes");
        }
        else
        {
            Debug.LogError("Failed to load from file!");
        }

        Debug.Log("=== Test Complete ===");
    }
}
